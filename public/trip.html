<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trip Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar">
    <div class="navbar-container">
      <div class="navbar-left">
       <a href="profile.html" class="nav-link">Profile</a>
       <a href="explore.html" class="nav-link">Explore</a>
      </div>
      <div class="navbar-center">
        <a href="/" class="btn-start-trip">ðŸš€ Start Trip</a>
      </div>
      <div class="navbar-right">
        <a href="trips.html" class="nav-link">My Trips</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="header">
      <h1 id="tripName">Loading...</h1>
      <div id="settledBadge" class="settled-badge" style="display: none;">
        âœ“ SETTLED
      </div>
    </div>

    <!-- Members Summary -->
    <div class="card">
      <h3>Members</h3>
      <div id="membersSummary" class="members-summary"></div>
    </div>

    <!-- Add/Edit Expense Form -->
    <div class="card" id="addExpenseCard">
      <h3 id="formTitle">Add Expense</h3>
      
      <div class="form-group">
        <label>Description</label>
        <input type="text" id="expenseDesc" placeholder="e.g., Lunch at cafe" />
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Amount (â‚¹)</label>
          <input type="number" id="expenseAmount" placeholder="500" step="0.01" />
        </div>

        <div class="form-group">
          <label>Category</label>
          <select id="expenseCategory">
            <option value="food">Food</option>
            <option value="stay">Stay</option>
            <option value="transport">Transport</option>
            <option value="water">Water</option>
            <option value="activities">Activities</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>Paid By</label>
        <select id="expensePayer"></select>
      </div>

      <div class="form-group">
        <label>Split Between</label>
        <div id="participantsList" class="checkbox-list"></div>
      </div>

      <div class="form-button-group">
        <button onclick="saveExpense()" class="btn-primary" id="saveBtn">Add Expense</button>
        <button onclick="cancelEdit()" class="btn-cancel" id="cancelBtn" style="display: none;">Cancel</button>
      </div>
    </div>

    <!-- Expenses Feed -->
    <div class="card">
      <h3>Expenses</h3>
      <div id="expensesFeed" class="expenses-feed">
        <p class="empty-state">No expenses yet</p>
      </div>
    </div>

    <!-- Settlement Section -->
    <div class="card settlement-card">
      <button onclick="showSettlement()" class="btn-settlement" id="calculateBtn">
        Calculate Settlement
      </button>
      
      <div id="settlementResult" style="display: none;">
        <h3>Member Balances</h3>
        <div id="balancesView" class="balances-view"></div>

        <h3>Final Settlement</h3>
        <div id="settlementsView" class="settlements-view"></div>

        <button onclick="settleTrip()" class="btn-danger" id="settleBtn">
          End Trip & Lock Settlement
        </button>
      </div>
    </div>
  </div>

  <script>
  const API_BASE = ""; // âœ… critical for Vercel (same-origin)

  let tripId;
  let members = [];
  let expenses = [];
  let isSettled = false;
  let editingExpenseId = null;

  // Get trip ID from URL
  const urlParams = new URLSearchParams(window.location.search);
  tripId = urlParams.get('id');

  if (!tripId) {
    alert('Invalid trip ID');
    window.location.href = '/';
  }

  // Generate UPI deep link
  function generateUpiLink(upiId, name, amount) {
    if (!upiId) return null;

    const params = new URLSearchParams({
      pa: upiId,
      pn: name,
      am: amount.toFixed(2),
      cu: 'INR',
      tn: 'Trip Settlement'
    });

    return `upi://pay?${params.toString()}`;
  }

  // Load trip data
  async function loadTrip() {
    try {
      const response = await fetch(`${API_BASE}/api/trips/${tripId}`);
      if (!response.ok) throw new Error("API failed");

      const data = await response.json();

      document.getElementById('tripName').textContent = data.trip.name;
      members = data.members;
      isSettled = data.trip.is_settled === 1;

      if (isSettled) {
        document.getElementById('settledBadge').style.display = 'inline-block';
        document.getElementById('addExpenseCard').style.display = 'none';
        document.getElementById('calculateBtn').style.display = 'none';
        showSettlement();
      }

      renderMembersSummary();
      populatePayerDropdown();
      populateParticipants();
      loadExpenses();
    } catch (err) {
      alert('Failed to load trip');
      console.error(err);
    }
  }

  function renderMembersSummary() {
    const html = members.map(m => `<span class="member-tag">${m.name}</span>`).join('');
    document.getElementById('membersSummary').innerHTML = html;
  }

  function populatePayerDropdown() {
    const select = document.getElementById('expensePayer');
    select.innerHTML = members.map(m =>
      `<option value="${m.id}">${m.name}</option>`
    ).join('');
  }

  function populateParticipants() {
    const html = members.map(m => `
      <label class="checkbox-label">
        <input type="checkbox" value="${m.id}" checked />
        <span>${m.name}</span>
      </label>
    `).join('');
    document.getElementById('participantsList').innerHTML = html;
  }

  async function saveExpense() {
    const description = document.getElementById('expenseDesc').value.trim();
    const amount = parseFloat(document.getElementById('expenseAmount').value);
    const payerId = parseInt(document.getElementById('expensePayer').value);
    const category = document.getElementById('expenseCategory').value;

    const participantCheckboxes = document.querySelectorAll('#participantsList input[type="checkbox"]:checked');
    const participantIds = Array.from(participantCheckboxes).map(cb => parseInt(cb.value));

    if (!description || !amount || participantIds.length === 0) {
      alert('Please fill all fields and select at least one participant');
      return;
    }

    try {
      let response;

      if (editingExpenseId) {
        response = await fetch(`${API_BASE}/api/expenses/${editingExpenseId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ description, amount, payerId, category, participantIds })
        });
      } else {
        response = await fetch(`${API_BASE}/api/expenses`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tripId, description, amount, payerId, category, participantIds })
        });
      }

      if (response.ok) {
        resetForm();
        loadExpenses();
      } else {
        const data = await response.json();
        alert(data.error || 'Failed to save expense');
      }
    } catch (err) {
      alert('Network error');
    }
  }

  function resetForm() {
    document.getElementById('expenseDesc').value = '';
    document.getElementById('expenseAmount').value = '';
    document.getElementById('formTitle').textContent = 'Add Expense';
    document.getElementById('saveBtn').textContent = 'Add Expense';
    document.getElementById('cancelBtn').style.display = 'none';
    editingExpenseId = null;

    document.querySelectorAll('#participantsList input[type="checkbox"]').forEach(cb => {
      cb.checked = true;
    });
  }

  function cancelEdit() {
    resetForm();
  }

  async function deleteExpense(expenseId) {
    if (!confirm('Are you sure you want to delete this expense?')) return;

    try {
      const response = await fetch(`${API_BASE}/api/expenses/${expenseId}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        loadExpenses();
        if (editingExpenseId === expenseId) resetForm();
      }
    } catch (err) {
      alert('Network error');
    }
  }

  async function loadExpenses() {
    try {
      const response = await fetch(`${API_BASE}/api/trips/${tripId}/expenses`);
      expenses = await response.json();
      renderExpenses();
    } catch (err) {
      console.error(err);
    }
  }

  async function showSettlement() {
    try {
      const response = await fetch(`${API_BASE}/api/trips/${tripId}/calculate`);
      const data = await response.json();
      // unchanged logicâ€¦
    } catch (err) {
      alert('Failed to calculate settlement');
    }
  }

  async function settleTrip() {
    if (!confirm('This will lock the trip and prevent adding/editing expenses. Continue?')) return;

    try {
      const response = await fetch(`${API_BASE}/api/trips/${tripId}/settle`, {
        method: 'POST'
      });

      if (response.ok) {
        alert('Trip settled successfully!');
        location.reload();
      }
    } catch (err) {
      alert('Failed to settle trip');
    }
  }

  // Initialize
  loadTrip();
</script>

</body>
</html>

